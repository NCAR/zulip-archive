[
    {
        "content": "<p>Hi all, <br>\nI have an issue with chunking while loading my dataset. I read my datasets like this</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">def</span> <span class=\"nf\">read_dat</span><span class=\"p\">(</span><span class=\"n\">files</span><span class=\"p\">,</span> <span class=\"n\">variables</span><span class=\"p\">,</span> <span class=\"n\">pop</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">,</span> <span class=\"n\">chunks</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;time&#39;</span><span class=\"p\">:</span><span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"s1\">&#39;nlat&#39;</span><span class=\"p\">:</span><span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"s1\">&#39;nlon&#39;</span><span class=\"p\">:</span><span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"s1\">&#39;z_t&#39;</span><span class=\"p\">:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">}):</span>\n    <span class=\"k\">def</span> <span class=\"nf\">preprocess</span><span class=\"p\">(</span><span class=\"n\">ds</span><span class=\"p\">):</span>\n        <span class=\"k\">return</span> <span class=\"n\">ds</span><span class=\"p\">[</span><span class=\"n\">variables</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">reset_coords</span><span class=\"p\">(</span><span class=\"n\">drop</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">)</span> <span class=\"c1\"># reset coords means they are reset as variables</span>\n    <span class=\"n\">ds</span> <span class=\"o\">=</span> <span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">open_mfdataset</span><span class=\"p\">(</span><span class=\"n\">files</span><span class=\"p\">,</span> <span class=\"n\">parallel</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span> <span class=\"n\">preprocess</span><span class=\"o\">=</span><span class=\"n\">preprocess</span><span class=\"p\">,</span>\n                           <span class=\"n\">chunks</span><span class=\"o\">=</span><span class=\"n\">chunks</span><span class=\"p\">,</span>\n                           <span class=\"n\">combine</span><span class=\"o\">=</span><span class=\"s1\">&#39;by_coords&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">if</span> <span class=\"n\">pop</span><span class=\"o\">==</span><span class=\"kc\">True</span><span class=\"p\">:</span>\n        <span class=\"n\">file0</span> <span class=\"o\">=</span> <span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">open_dataset</span><span class=\"p\">(</span><span class=\"n\">files</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">],</span> <span class=\"n\">chunks</span><span class=\"o\">=</span><span class=\"n\">chunks</span><span class=\"p\">)</span>\n        <span class=\"n\">ds</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">file0</span><span class=\"p\">[[</span><span class=\"s1\">&#39;ULONG&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;ULAT&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;TLONG&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;TLAT&#39;</span><span class=\"p\">]])</span>\n        <span class=\"n\">file0</span><span class=\"o\">.</span><span class=\"n\">close</span><span class=\"p\">()</span>\n\n    <span class=\"n\">ds</span>\n    <span class=\"k\">return</span> <span class=\"n\">ds</span>\n</pre></div>\n\n\n<p>but somehow this doesn't result in the desired chunks (120MB each) when I use it </p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">flist</span> <span class=\"o\">=</span> <span class=\"n\">glob</span><span class=\"o\">.</span><span class=\"n\">glob</span><span class=\"p\">(</span><span class=\"s1\">&#39;/project/oce/deppenme/process-dat/more_years/Pac_POP0.1_JRA_IAF_*.nc&#39;</span><span class=\"p\">)</span>\n<span class=\"n\">ds_misc</span> <span class=\"o\">=</span> <span class=\"n\">read_dat</span><span class=\"p\">(</span><span class=\"n\">flist</span><span class=\"p\">,</span> <span class=\"p\">[</span><span class=\"s1\">&#39;TEMP&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;WVEL&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;UVEL&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;VVEL&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;DIA_IMPVF_TEMP&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Q&#39;</span><span class=\"p\">],</span> <span class=\"n\">pop</span><span class=\"o\">=</span><span class=\"kc\">True</span><span class=\"p\">,</span>\n                  <span class=\"n\">chunks</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s1\">&#39;time&#39;</span><span class=\"p\">:</span><span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"s1\">&#39;nlat&#39;</span><span class=\"p\">:</span><span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"s1\">&#39;nlon&#39;</span><span class=\"p\">:</span><span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"s1\">&#39;z_t&#39;</span><span class=\"p\">:</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">})</span>\n</pre></div>\n\n\n<p><a href=\"/user_uploads/2/c/eZMKVecdiTDKr7soNXfLi6ps/pasted_image.png\" target=\"_blank\" title=\"pasted_image.png\">pasted image</a> <br>\nAny ideas how to better do this? <br>\n(I am currently trying chunking while just reading with <code>xr.open_mfdataset()</code> and it takes way too long)</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/2/c/eZMKVecdiTDKr7soNXfLi6ps/pasted_image.png\" target=\"_blank\" title=\"pasted image\"><img src=\"/user_uploads/2/c/eZMKVecdiTDKr7soNXfLi6ps/pasted_image.png\"></a></div>",
        "id": 28417,
        "sender_full_name": "Anna-Lena Deppenmeier",
        "timestamp": 1617386668
    },
    {
        "content": "<p>It looks like you have one file per timestep, so <code>open_mfdataset</code> cannot apply chunking along time. I would chunk the other 3 dimensions to make bigger chunks, if you can. If you really need to chunk along time, you'll have to do it after reading the files.</p>",
        "id": 28418,
        "sender_full_name": "Deepak Cherian",
        "timestamp": 1617386966
    },
    {
        "content": "<p>Thanks! Trying other chunks to get to the desired chunk size.</p>",
        "id": 28421,
        "sender_full_name": "Anna-Lena Deppenmeier",
        "timestamp": 1617387756
    }
]