[
    {
        "content": "<p>I am trying to write an xarray dataset after manipulating the coordinates, and for reason unbeknownst to me  xarray seems to be doing what I didn't tell it to do. Here's a minimal example:</p>\n<ul>\n<li>Read the data</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">14</span><span class=\"p\">]:</span> <span class=\"kn\">import</span> <span class=\"nn\">xarray</span> <span class=\"kn\">as</span> <span class=\"nn\">xr</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">15</span><span class=\"p\">]:</span> <span class=\"n\">ds</span> <span class=\"o\">=</span> <span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">tutorial</span><span class=\"o\">.</span><span class=\"n\">open_dataset</span><span class=\"p\">(</span><span class=\"s1\">'rasm'</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">chunk</span><span class=\"p\">()</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"p\">]:</span> <span class=\"n\">ds</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"p\">]:</span>\n<span class=\"o\">&lt;</span><span class=\"n\">xarray</span><span class=\"o\">.</span><span class=\"n\">Dataset</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Dimensions</span><span class=\"p\">:</span>  <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">:</span> <span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">:</span> <span class=\"mi\">275</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">:</span> <span class=\"mi\">205</span><span class=\"p\">)</span>\n<span class=\"n\">Coordinates</span><span class=\"p\">:</span>\n  <span class=\"o\">*</span> <span class=\"n\">time</span>     <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">)</span> <span class=\"nb\">object</span> <span class=\"mi\">1980</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">16</span> <span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span> <span class=\"o\">...</span> <span class=\"mi\">1983</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">17</span> <span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span>\n    <span class=\"n\">xc</span>       <span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">yc</span>       <span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Dimensions</span> <span class=\"n\">without</span> <span class=\"n\">coordinates</span><span class=\"p\">:</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">y</span>\n<span class=\"n\">Data</span> <span class=\"n\">variables</span><span class=\"p\">:</span>\n    <span class=\"n\">Tair</span>     <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Attributes</span><span class=\"p\">:</span>\n    <span class=\"n\">title</span><span class=\"p\">:</span>                     <span class=\"o\">/</span><span class=\"n\">workspace</span><span class=\"o\">/</span><span class=\"n\">jhamman</span><span class=\"o\">/</span><span class=\"n\">processed</span><span class=\"o\">/</span><span class=\"n\">R1002RBRxaaa01a</span><span class=\"o\">/</span><span class=\"n\">l</span><span class=\"o\">...</span>\n    <span class=\"n\">institution</span><span class=\"p\">:</span>               <span class=\"n\">U</span><span class=\"o\">.</span><span class=\"n\">W</span><span class=\"o\">.</span>\n    <span class=\"n\">source</span><span class=\"p\">:</span>                    <span class=\"n\">RACM</span> <span class=\"n\">R1002RBRxaaa01a</span>\n    <span class=\"n\">output_frequency</span><span class=\"p\">:</span>          <span class=\"n\">daily</span>\n    <span class=\"n\">output_mode</span><span class=\"p\">:</span>               <span class=\"n\">averaged</span>\n    <span class=\"n\">convention</span><span class=\"p\">:</span>                <span class=\"n\">CF</span><span class=\"o\">-</span><span class=\"mf\">1.4</span>\n    <span class=\"n\">references</span><span class=\"p\">:</span>                <span class=\"n\">Based</span> <span class=\"n\">on</span> <span class=\"n\">the</span> <span class=\"n\">initial</span> <span class=\"n\">model</span> <span class=\"n\">of</span> <span class=\"n\">Liang</span> <span class=\"n\">et</span> <span class=\"n\">al</span><span class=\"o\">.</span><span class=\"p\">,</span> <span class=\"mf\">19.</span><span class=\"o\">..</span>\n    <span class=\"n\">comment</span><span class=\"p\">:</span>                   <span class=\"n\">Output</span> <span class=\"kn\">from</span> <span class=\"nn\">the</span> <span class=\"nn\">Variable</span> <span class=\"nn\">Infiltration</span> <span class=\"nn\">Capacity...</span>\n    <span class=\"n\">nco_openmp_thread_number</span><span class=\"p\">:</span>  <span class=\"mi\">1</span>\n    <span class=\"n\">NCO</span><span class=\"p\">:</span>                       <span class=\"s2\">\"4.6.0\"</span>\n    <span class=\"n\">history</span><span class=\"p\">:</span>                   <span class=\"n\">Tue</span> <span class=\"n\">Dec</span> <span class=\"mi\">27</span> <span class=\"mi\">14</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">22</span> <span class=\"mi\">2016</span><span class=\"p\">:</span> <span class=\"n\">ncatted</span> <span class=\"o\">-</span><span class=\"n\">a</span> <span class=\"n\">dimension</span><span class=\"o\">...</span>\n</pre></div>\n<ul>\n<li>Define a function for restoring non-dim coordinates:</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">17</span><span class=\"p\">]:</span> <span class=\"k\">def</span> <span class=\"nf\">_restore_non_dim_coords</span><span class=\"p\">(</span><span class=\"n\">ds</span><span class=\"p\">):</span>\n    <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"s2\">\"\"\"restore non_dim_coords to variables\"\"\"</span>\n    <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"n\">non_dim_coords_reset</span> <span class=\"o\">=</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">ds</span><span class=\"o\">.</span><span class=\"n\">coords</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"nb\">set</span><span class=\"p\">(</span><span class=\"n\">ds</span><span class=\"o\">.</span><span class=\"n\">dims</span><span class=\"p\">)</span>\n    <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"n\">ds</span> <span class=\"o\">=</span> <span class=\"n\">ds</span><span class=\"o\">.</span><span class=\"n\">reset_coords</span><span class=\"p\">(</span><span class=\"n\">non_dim_coords_reset</span><span class=\"p\">)</span>\n    <span class=\"o\">...</span><span class=\"p\">:</span>     <span class=\"k\">return</span> <span class=\"n\">ds</span>\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">18</span><span class=\"p\">]:</span> <span class=\"n\">ds2</span> <span class=\"o\">=</span> <span class=\"n\">_restore_non_dim_coords</span><span class=\"p\">(</span><span class=\"n\">ds</span><span class=\"p\">)</span>\n</pre></div>\n<ul>\n<li>As you can see, at this point (xc, yc) have been promoted to be <code>data_variables</code>:</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">19</span><span class=\"p\">]:</span> <span class=\"n\">ds2</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">19</span><span class=\"p\">]:</span>\n<span class=\"o\">&lt;</span><span class=\"n\">xarray</span><span class=\"o\">.</span><span class=\"n\">Dataset</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Dimensions</span><span class=\"p\">:</span>  <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">:</span> <span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">:</span> <span class=\"mi\">275</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">:</span> <span class=\"mi\">205</span><span class=\"p\">)</span>\n<span class=\"n\">Coordinates</span><span class=\"p\">:</span>\n  <span class=\"o\">*</span> <span class=\"n\">time</span>     <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">)</span> <span class=\"nb\">object</span> <span class=\"mi\">1980</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">16</span> <span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span> <span class=\"o\">...</span> <span class=\"mi\">1983</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">17</span> <span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span>\n<span class=\"n\">Dimensions</span> <span class=\"n\">without</span> <span class=\"n\">coordinates</span><span class=\"p\">:</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">y</span>\n<span class=\"n\">Data</span> <span class=\"n\">variables</span><span class=\"p\">:</span>\n    <span class=\"n\">Tair</span>     <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">xc</span>       <span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">yc</span>       <span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Attributes</span><span class=\"p\">:</span>\n    <span class=\"n\">title</span><span class=\"p\">:</span>                     <span class=\"o\">/</span><span class=\"n\">workspace</span><span class=\"o\">/</span><span class=\"n\">jhamman</span><span class=\"o\">/</span><span class=\"n\">processed</span><span class=\"o\">/</span><span class=\"n\">R1002RBRxaaa01a</span><span class=\"o\">/</span><span class=\"n\">l</span><span class=\"o\">...</span>\n    <span class=\"n\">institution</span><span class=\"p\">:</span>               <span class=\"n\">U</span><span class=\"o\">.</span><span class=\"n\">W</span><span class=\"o\">.</span>\n    <span class=\"n\">source</span><span class=\"p\">:</span>                    <span class=\"n\">RACM</span> <span class=\"n\">R1002RBRxaaa01a</span>\n    <span class=\"n\">output_frequency</span><span class=\"p\">:</span>          <span class=\"n\">daily</span>\n    <span class=\"n\">output_mode</span><span class=\"p\">:</span>               <span class=\"n\">averaged</span>\n    <span class=\"n\">convention</span><span class=\"p\">:</span>                <span class=\"n\">CF</span><span class=\"o\">-</span><span class=\"mf\">1.4</span>\n    <span class=\"n\">references</span><span class=\"p\">:</span>                <span class=\"n\">Based</span> <span class=\"n\">on</span> <span class=\"n\">the</span> <span class=\"n\">initial</span> <span class=\"n\">model</span> <span class=\"n\">of</span> <span class=\"n\">Liang</span> <span class=\"n\">et</span> <span class=\"n\">al</span><span class=\"o\">.</span><span class=\"p\">,</span> <span class=\"mf\">19.</span><span class=\"o\">..</span>\n    <span class=\"n\">comment</span><span class=\"p\">:</span>                   <span class=\"n\">Output</span> <span class=\"kn\">from</span> <span class=\"nn\">the</span> <span class=\"nn\">Variable</span> <span class=\"nn\">Infiltration</span> <span class=\"nn\">Capacity...</span>\n    <span class=\"n\">nco_openmp_thread_number</span><span class=\"p\">:</span>  <span class=\"mi\">1</span>\n    <span class=\"n\">NCO</span><span class=\"p\">:</span>                       <span class=\"s2\">\"4.6.0\"</span>\n    <span class=\"n\">history</span><span class=\"p\">:</span>                   <span class=\"n\">Tue</span> <span class=\"n\">Dec</span> <span class=\"mi\">27</span> <span class=\"mi\">14</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">22</span> <span class=\"mi\">2016</span><span class=\"p\">:</span> <span class=\"n\">ncatted</span> <span class=\"o\">-</span><span class=\"n\">a</span> <span class=\"n\">dimension</span><span class=\"o\">...</span>\n</pre></div>\n<p>When I write the data, and read it back in, I get unexpected results i.e. (xc, yc) have been moved back to coordinates:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">20</span><span class=\"p\">]:</span> <span class=\"n\">ds2</span><span class=\"o\">.</span><span class=\"n\">to_zarr</span><span class=\"p\">(</span><span class=\"s2\">\"test.zarr\"</span><span class=\"p\">,</span> <span class=\"n\">consolidated</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">20</span><span class=\"p\">]:</span> <span class=\"o\">&lt;</span><span class=\"n\">xarray</span><span class=\"o\">.</span><span class=\"n\">backends</span><span class=\"o\">.</span><span class=\"n\">zarr</span><span class=\"o\">.</span><span class=\"n\">ZarrStore</span> <span class=\"n\">at</span> <span class=\"mh\">0x2b6dd7a08e90</span><span class=\"o\">&gt;</span>\n\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">21</span><span class=\"p\">]:</span> <span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">open_zarr</span><span class=\"p\">(</span><span class=\"s2\">\"test.zarr\"</span><span class=\"p\">,</span> <span class=\"n\">consolidated</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">21</span><span class=\"p\">]:</span>\n<span class=\"o\">&lt;</span><span class=\"n\">xarray</span><span class=\"o\">.</span><span class=\"n\">Dataset</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Dimensions</span><span class=\"p\">:</span>  <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">:</span> <span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">:</span> <span class=\"mi\">275</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">:</span> <span class=\"mi\">205</span><span class=\"p\">)</span>\n<span class=\"n\">Coordinates</span><span class=\"p\">:</span>\n  <span class=\"o\">*</span> <span class=\"n\">time</span>     <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">)</span> <span class=\"nb\">object</span> <span class=\"mi\">1980</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">16</span> <span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span> <span class=\"o\">...</span> <span class=\"mi\">1983</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">17</span> <span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span>\n    <span class=\"n\">xc</span>       <span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">yc</span>       <span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Dimensions</span> <span class=\"n\">without</span> <span class=\"n\">coordinates</span><span class=\"p\">:</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">y</span>\n<span class=\"n\">Data</span> <span class=\"n\">variables</span><span class=\"p\">:</span>\n    <span class=\"n\">Tair</span>     <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Attributes</span><span class=\"p\">:</span>\n    <span class=\"n\">NCO</span><span class=\"p\">:</span>                       <span class=\"s2\">\"4.6.0\"</span>\n    <span class=\"n\">comment</span><span class=\"p\">:</span>                   <span class=\"n\">Output</span> <span class=\"kn\">from</span> <span class=\"nn\">the</span> <span class=\"nn\">Variable</span> <span class=\"nn\">Infiltration</span> <span class=\"nn\">Capacity...</span>\n    <span class=\"n\">convention</span><span class=\"p\">:</span>                <span class=\"n\">CF</span><span class=\"o\">-</span><span class=\"mf\">1.4</span>\n    <span class=\"n\">history</span><span class=\"p\">:</span>                   <span class=\"n\">Tue</span> <span class=\"n\">Dec</span> <span class=\"mi\">27</span> <span class=\"mi\">14</span><span class=\"p\">:</span><span class=\"mi\">15</span><span class=\"p\">:</span><span class=\"mi\">22</span> <span class=\"mi\">2016</span><span class=\"p\">:</span> <span class=\"n\">ncatted</span> <span class=\"o\">-</span><span class=\"n\">a</span> <span class=\"n\">dimension</span><span class=\"o\">...</span>\n    <span class=\"n\">institution</span><span class=\"p\">:</span>               <span class=\"n\">U</span><span class=\"o\">.</span><span class=\"n\">W</span><span class=\"o\">.</span>\n    <span class=\"n\">nco_openmp_thread_number</span><span class=\"p\">:</span>  <span class=\"mi\">1</span>\n    <span class=\"n\">output_frequency</span><span class=\"p\">:</span>          <span class=\"n\">daily</span>\n    <span class=\"n\">output_mode</span><span class=\"p\">:</span>               <span class=\"n\">averaged</span>\n    <span class=\"n\">references</span><span class=\"p\">:</span>                <span class=\"n\">Based</span> <span class=\"n\">on</span> <span class=\"n\">the</span> <span class=\"n\">initial</span> <span class=\"n\">model</span> <span class=\"n\">of</span> <span class=\"n\">Liang</span> <span class=\"n\">et</span> <span class=\"n\">al</span><span class=\"o\">.</span><span class=\"p\">,</span> <span class=\"mf\">19.</span><span class=\"o\">..</span>\n    <span class=\"n\">source</span><span class=\"p\">:</span>                    <span class=\"n\">RACM</span> <span class=\"n\">R1002RBRxaaa01a</span>\n    <span class=\"n\">title</span><span class=\"p\">:</span>                     <span class=\"o\">/</span><span class=\"n\">workspace</span><span class=\"o\">/</span><span class=\"n\">jhamman</span><span class=\"o\">/</span><span class=\"n\">processed</span><span class=\"o\">/</span><span class=\"n\">R1002RBRxaaa01a</span><span class=\"o\">/</span><span class=\"n\">l</span><span class=\"o\">...</span>\n</pre></div>\n<p>Am I missing something? I am trying to determine whether this is a bug that needs to be reported upstream (in xarray) or whether this is the expected behavior. </p>\n<p>Cc <span class=\"user-mention\" data-user-id=\"25\">@Deepak Cherian</span>, <span class=\"user-mention\" data-user-id=\"32\">@Joe Hamman</span>  in case  you have suggestions on addressing this issue.</p>",
        "id": 4409,
        "sender_full_name": "Anderson Banihirwe",
        "timestamp": 1584749743
    },
    {
        "content": "<p>The <code>coordinates</code> attribute is set on either <code>attrs</code> or <code>encoding</code> those variables (most likely). [I think] This behaviour exists so you can get perfect roundtripping if <code>decode_coords=False</code> (i.e. a coordinates attribute was set but variables were not converted to coordinates). We could raise a <code>SerializationWarning</code> when this is the case. See <a href=\"https://github.com/pydata/xarray/pull/3487\" target=\"_blank\" title=\"https://github.com/pydata/xarray/pull/3487\">https://github.com/pydata/xarray/pull/3487</a>.</p>",
        "id": 4410,
        "sender_full_name": "Deepak Cherian",
        "timestamp": 1584800859
    },
    {
        "content": "<p>Thank you for the clarification, <span class=\"user-mention\" data-user-id=\"25\">@Deepak Cherian</span>! I wasn't aware of the changes introduced by <a href=\"https://github.com/pydata/xarray/pull/3487\" target=\"_blank\" title=\"https://github.com/pydata/xarray/pull/3487\">https://github.com/pydata/xarray/pull/3487</a> (and my confusion was mostly due to the fact in the past (prior v0.14.1) I had done this manipulation successfully). </p>\n<blockquote>\n<p>The coordinates attribute is set on either attrs or encoding those variables (most likely).</p>\n</blockquote>\n<p>Indeed:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">43</span><span class=\"p\">]:</span> <span class=\"n\">ds</span><span class=\"o\">.</span><span class=\"n\">Tair</span><span class=\"o\">.</span><span class=\"n\">encoding</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">43</span><span class=\"p\">]:</span>\n<span class=\"p\">{</span><span class=\"s1\">'source'</span><span class=\"p\">:</span> <span class=\"s1\">'/Users/abanihi/.xarray_tutorial_data/rasm.nc'</span><span class=\"p\">,</span>\n <span class=\"s1\">'original_shape'</span><span class=\"p\">:</span> <span class=\"p\">(</span><span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span>\n <span class=\"s1\">'dtype'</span><span class=\"p\">:</span> <span class=\"n\">dtype</span><span class=\"p\">(</span><span class=\"s1\">'float64'</span><span class=\"p\">),</span>\n <span class=\"s1\">'_FillValue'</span><span class=\"p\">:</span> <span class=\"mf\">9.969209968386869e+36</span><span class=\"p\">,</span>\n <span class=\"s1\">'coordinates'</span><span class=\"p\">:</span> <span class=\"s1\">'yc xc'</span><span class=\"p\">}</span>\n</pre></div>\n<p>Deleting the coordinates key from the encoding gave me the outcome I was looking for </p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">45</span><span class=\"p\">]:</span> <span class=\"k\">del</span> <span class=\"n\">ds2</span><span class=\"o\">.</span><span class=\"n\">Tair</span><span class=\"o\">.</span><span class=\"n\">encoding</span><span class=\"p\">[</span><span class=\"s1\">'coordinates'</span><span class=\"p\">]</span>\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">48</span><span class=\"p\">]:</span> <span class=\"n\">ds2</span><span class=\"o\">.</span><span class=\"n\">to_zarr</span><span class=\"p\">(</span><span class=\"s1\">'test.zarr'</span><span class=\"p\">,</span> <span class=\"n\">consolidated</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">48</span><span class=\"p\">]:</span> <span class=\"o\">&lt;</span><span class=\"n\">xarray</span><span class=\"o\">.</span><span class=\"n\">backends</span><span class=\"o\">.</span><span class=\"n\">zarr</span><span class=\"o\">.</span><span class=\"n\">ZarrStore</span> <span class=\"n\">at</span> <span class=\"mh\">0x12a960a10</span><span class=\"o\">&gt;</span>\n<span class=\"n\">In</span> <span class=\"p\">[</span><span class=\"mi\">50</span><span class=\"p\">]:</span> <span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">open_zarr</span><span class=\"p\">(</span><span class=\"s1\">'test.zarr'</span><span class=\"p\">,</span> <span class=\"n\">consolidated</span><span class=\"o\">=</span><span class=\"bp\">True</span><span class=\"p\">)</span>\n<span class=\"n\">Out</span><span class=\"p\">[</span><span class=\"mi\">50</span><span class=\"p\">]:</span>\n<span class=\"o\">&lt;</span><span class=\"n\">xarray</span><span class=\"o\">.</span><span class=\"n\">Dataset</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Dimensions</span><span class=\"p\">:</span>  <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">:</span> <span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">:</span> <span class=\"mi\">275</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">:</span> <span class=\"mi\">205</span><span class=\"p\">)</span>\n<span class=\"n\">Coordinates</span><span class=\"p\">:</span>\n  <span class=\"o\">*</span> <span class=\"n\">time</span>     <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">)</span> <span class=\"nb\">object</span> <span class=\"mi\">1980</span><span class=\"o\">-</span><span class=\"mi\">09</span><span class=\"o\">-</span><span class=\"mi\">16</span> <span class=\"mi\">12</span><span class=\"p\">:</span><span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span> <span class=\"o\">...</span> <span class=\"mi\">1983</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">17</span> <span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span><span class=\"p\">:</span><span class=\"mo\">00</span>\n<span class=\"n\">Dimensions</span> <span class=\"n\">without</span> <span class=\"n\">coordinates</span><span class=\"p\">:</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">y</span>\n<span class=\"n\">Data</span> <span class=\"n\">variables</span><span class=\"p\">:</span>\n    <span class=\"n\">Tair</span>     <span class=\"p\">(</span><span class=\"n\">time</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">36</span><span class=\"p\">,</span> <span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">xc</span>       <span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n    <span class=\"n\">yc</span>       <span class=\"p\">(</span><span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">x</span><span class=\"p\">)</span> <span class=\"n\">float64</span> <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">chunksize</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"mi\">205</span><span class=\"p\">,</span> <span class=\"mi\">275</span><span class=\"p\">),</span> <span class=\"n\">meta</span><span class=\"o\">=</span><span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">ndarray</span><span class=\"o\">&gt;</span>\n</pre></div>",
        "id": 4415,
        "sender_full_name": "Anderson Banihirwe",
        "timestamp": 1584820214
    }
]