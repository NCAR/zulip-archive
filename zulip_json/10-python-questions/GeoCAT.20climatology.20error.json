[
    {
        "content": "<p>Hi all,<br>\nI'm getting an error while using the GeoCAT function <code>climate_anomaly</code>. The error is <code>AttributeError: 'DataArray' object has no attribute '_data'</code>. The data is from the CESM2 large ensemble. Here's a complete example that I was just trying to run on casper:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"kn\">from</span> <span class=\"nn\">pathlib</span> <span class=\"kn\">import</span> <span class=\"n\">Path</span>\n<span class=\"kn\">import</span> <span class=\"nn\">xarray</span> <span class=\"k\">as</span> <span class=\"nn\">xr</span>\n<span class=\"kn\">import</span> <span class=\"nn\">numpy</span> <span class=\"k\">as</span> <span class=\"nn\">np</span>\n<span class=\"kn\">import</span> <span class=\"nn\">geocat.comp</span> <span class=\"k\">as</span> <span class=\"nn\">gc</span>\n\n<span class=\"c1\">#</span>\n<span class=\"c1\"># LOAD SST FOR ONE MEMBER OF CESM2 LARGE ENSEMBLE</span>\n<span class=\"c1\">#</span>\n<span class=\"n\">varname</span> <span class=\"o\">=</span> <span class=\"s2\">\"SST\"</span>\n<span class=\"n\">loc</span> <span class=\"o\">=</span> <span class=\"n\">Path</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">\"/glade/campaign/cgd/cesm/CESM2-LE/timeseries/atm/proc/tseries/month_1/</span><span class=\"si\">{</span><span class=\"n\">varname</span><span class=\"si\">}</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n<span class=\"n\">case</span> <span class=\"o\">=</span> <span class=\"s2\">\"b.e21.BHISTcmip6.f09_g17.LE2-1281.002\"</span>\n<span class=\"n\">srch</span> <span class=\"o\">=</span> <span class=\"sa\">f</span><span class=\"s2\">\".cam.h0.</span><span class=\"si\">{</span><span class=\"n\">varname</span><span class=\"si\">}</span><span class=\"s2\">.*.nc\"</span>\n<span class=\"n\">fils</span> <span class=\"o\">=</span> <span class=\"nb\">sorted</span><span class=\"p\">(</span><span class=\"n\">loc</span><span class=\"o\">.</span><span class=\"n\">glob</span><span class=\"p\">(</span><span class=\"n\">case</span><span class=\"o\">+</span><span class=\"n\">srch</span><span class=\"p\">))</span>\n<span class=\"nb\">print</span><span class=\"p\">(</span><span class=\"sa\">f</span><span class=\"s2\">\"Found </span><span class=\"si\">{</span><span class=\"nb\">len</span><span class=\"p\">(</span><span class=\"n\">fils</span><span class=\"p\">)</span><span class=\"si\">}</span><span class=\"s2\"> files.\"</span><span class=\"p\">)</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\"># open dataset and correct the time coordinate to month mid-point</span>\n<span class=\"c1\">#</span>\n<span class=\"n\">ds</span> <span class=\"o\">=</span> <span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">open_mfdataset</span><span class=\"p\">(</span><span class=\"n\">fils</span><span class=\"p\">,</span> <span class=\"n\">decode_times</span><span class=\"o\">=</span><span class=\"kc\">False</span><span class=\"p\">)</span>\n<span class=\"n\">t</span> <span class=\"o\">=</span> <span class=\"n\">ds</span><span class=\"p\">[</span><span class=\"s1\">'time_bnds'</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">dim</span><span class=\"o\">=</span><span class=\"s1\">'nbnd'</span><span class=\"p\">)</span>\n<span class=\"n\">t</span><span class=\"o\">.</span><span class=\"n\">attrs</span> <span class=\"o\">=</span> <span class=\"n\">ds</span><span class=\"o\">.</span><span class=\"n\">time</span><span class=\"o\">.</span><span class=\"n\">attrs</span>\n<span class=\"n\">ds</span> <span class=\"o\">=</span> <span class=\"n\">ds</span><span class=\"o\">.</span><span class=\"n\">assign_coords</span><span class=\"p\">({</span><span class=\"s2\">\"time\"</span><span class=\"p\">:</span><span class=\"n\">t</span><span class=\"p\">})</span>\n<span class=\"n\">ds</span> <span class=\"o\">=</span> <span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">decode_cf</span><span class=\"p\">(</span><span class=\"n\">ds</span><span class=\"p\">)</span>\n<span class=\"c1\">#</span>\n<span class=\"c1\"># calculate the SST anomaly using GeoCAT</span>\n<span class=\"c1\">#</span>\n<span class=\"n\">ds_p_anom</span> <span class=\"o\">=</span> <span class=\"n\">gc</span><span class=\"o\">.</span><span class=\"n\">climate_anomaly</span><span class=\"p\">(</span><span class=\"n\">ds</span><span class=\"p\">[</span><span class=\"n\">varname</span><span class=\"p\">],</span> <span class=\"s1\">'month'</span><span class=\"p\">,</span> <span class=\"n\">time_dim</span><span class=\"o\">=</span><span class=\"s1\">'time'</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Anyone have any input for this?</p>\n<p>Note that replacing the last line with these two lines seems to work  (and the whole thing runs in about 13s):</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code><span class=\"n\">climo</span> <span class=\"o\">=</span> <span class=\"n\">ds</span><span class=\"p\">[</span><span class=\"n\">varname</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">groupby</span><span class=\"p\">(</span><span class=\"s1\">'time.month'</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">mean</span><span class=\"p\">(</span><span class=\"n\">dim</span><span class=\"o\">=</span><span class=\"s1\">'time'</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">compute</span><span class=\"p\">()</span>\n<span class=\"n\">anom</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"n\">ds</span><span class=\"p\">[</span><span class=\"n\">varname</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">groupby</span><span class=\"p\">(</span><span class=\"s1\">'time.month'</span><span class=\"p\">)</span> <span class=\"o\">-</span> <span class=\"n\">climo</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">compute</span><span class=\"p\">()</span>\n</code></pre></div>",
        "id": 88327,
        "sender_full_name": "Brian Medeiros",
        "timestamp": 1694105439
    },
    {
        "content": "<p>There is an issue with how geocat is currently working with XArray (<a href=\"https://github.com/NCAR/geocat-comp/issues/381#issuecomment-1627832266\">https://github.com/NCAR/geocat-comp/issues/381#issuecomment-1627832266</a>)</p>",
        "id": 88328,
        "sender_full_name": "Cora Schneck",
        "timestamp": 1694105637
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"364\">@Cora Schneck</span>  That is definitely the same issue I'm hitting.</p>",
        "id": 88329,
        "sender_full_name": "Brian Medeiros",
        "timestamp": 1694105827
    },
    {
        "content": "<p>There is the local fix (by changing contains_cftime_datetimes), but I'm not sure about a more general fix</p>",
        "id": 88331,
        "sender_full_name": "Cora Schneck",
        "timestamp": 1694105947
    },
    {
        "content": "<p>Here is a <a href=\"https://github.com/pydata/xarray/issues/7645#issuecomment-1475150683\">more general solution</a></p>\n<p>So I believe it should be:<br>\n<code>ds = xr.decode_cf(ds)</code><br>\n To<br>\n<code>ds = xr.decode_cf(ds.variable)</code></p>",
        "id": 88344,
        "sender_full_name": "Cora Schneck",
        "timestamp": 1694109620
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"61\">@Brian Medeiros</span>  This is also an open issue on geocat-comp. Pinning <code>xarray&lt;=2023.02.0</code> should get you around the error until we address it in a release.</p>",
        "id": 88350,
        "sender_full_name": "Anissa Zacharias",
        "timestamp": 1694109978
    }
]