[
    {
        "content": "<p>In looking at Isla's notebook (how do I link to a thread?) , I noticed that the regridding step is slow. xesmf seems to use <code>dask.array.map_blocks(lambda x: x.dot(weights))</code> approach i.e. mapping numpy's dot on each block.. I wonder if <code>x.dot(weights)</code> i.e. using <code>dask.array.dot</code> to deal with the blocks would work better. </p>\n<p>From <a href=\"https://github.com/JiaweiZhuang/xESMF/issues/3\" target=\"_blank\" title=\"https://github.com/JiaweiZhuang/xESMF/issues/3\">https://github.com/JiaweiZhuang/xESMF/issues/3</a> and <a href=\"https://nbviewer.jupyter.org/github/JiaweiZhuang/sparse_dot/blob/master/sparse_dot_benchmark.ipynb\" target=\"_blank\" title=\"https://nbviewer.jupyter.org/github/JiaweiZhuang/sparse_dot/blob/master/sparse_dot_benchmark.ipynb\">https://nbviewer.jupyter.org/github/JiaweiZhuang/sparse_dot/blob/master/sparse_dot_benchmark.ipynb</a> the initial benchmarking was done before dask could wrap sparse arrays so it should be worth the effort to update that notebook</p>\n<p>I'm thinking something like</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">weights</span> <span class=\"o\">=</span> <span class=\"o\">...</span> <span class=\"c1\"># get weights from Regridder object</span>\n<span class=\"n\">sparse_weights</span> <span class=\"o\">=</span> <span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">DataArray</span><span class=\"p\">(</span>\n    <span class=\"n\">dask</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"o\">.</span><span class=\"n\">from_array</span><span class=\"p\">(</span>\n        <span class=\"n\">sparse</span><span class=\"o\">.</span><span class=\"n\">COO</span><span class=\"o\">.</span><span class=\"n\">from_scipy_sparse</span><span class=\"p\">(</span><span class=\"n\">weights</span><span class=\"p\">),</span>\n        <span class=\"n\">chunks</span><span class=\"o\">=...</span>\n    <span class=\"p\">),</span>\n    <span class=\"n\">dims</span><span class=\"o\">=...</span>\n<span class=\"p\">)</span>\n<span class=\"c1\"># client.scatter(sparse_weights)  # necessary? does this help?</span>\n<span class=\"n\">xr</span><span class=\"o\">.</span><span class=\"n\">dot</span><span class=\"p\">(</span><span class=\"n\">dataset</span><span class=\"p\">,</span> <span class=\"n\">sparse_weights</span><span class=\"p\">)</span>\n</pre></div>\n\n\n<p>vs</p>\n<div class=\"codehilite\"><pre><span></span>Regridder(dataset)\n</pre></div>\n\n\n<p>cc <span class=\"user-group-mention\" data-user-group-id=\"4\">@xdev</span>  good \"team time\" project?</p>",
        "id": 26050,
        "sender_full_name": "Deepak Cherian",
        "timestamp": 1614701945
    },
    {
        "content": "<p>original convo here: <a href=\"#narrow/stream/27-dask/topic/optimizing.20workers.20and.20memory/near/25977\" title=\"#narrow/stream/27-dask/topic/optimizing.20workers.20and.20memory/near/25977\">https://zulip2.cloud.ucar.edu/#narrow/stream/27-dask/topic/optimizing.20workers.20and.20memory/near/25977</a></p>",
        "id": 26052,
        "sender_full_name": "Deepak Cherian",
        "timestamp": 1614702626
    },
    {
        "content": "<p>May not be a definite win:</p>\n<ol>\n<li><a href=\"https://github.com/SciTools-incubator/iris-esmf-regrid/pull/23\" target=\"_blank\" title=\"https://github.com/SciTools-incubator/iris-esmf-regrid/pull/23\">https://github.com/SciTools-incubator/iris-esmf-regrid/pull/23</a></li>\n<li><a href=\"https://github.com/ravwojdyla/dask/blob/rav/matmul_blockwise_perf/matmul_perf.ipynb\" target=\"_blank\" title=\"https://github.com/ravwojdyla/dask/blob/rav/matmul_blockwise_perf/matmul_perf.ipynb\">https://github.com/ravwojdyla/dask/blob/rav/matmul_blockwise_perf/matmul_perf.ipynb</a></li>\n<li><a href=\"https://github.com/pangeo-data/pangeo/issues/756\" target=\"_blank\" title=\"https://github.com/pangeo-data/pangeo/issues/756\">https://github.com/pangeo-data/pangeo/issues/756</a></li>\n<li><a href=\"https://github.com/dask/dask/issues/6916\" target=\"_blank\" title=\"https://github.com/dask/dask/issues/6916\">https://github.com/dask/dask/issues/6916</a></li>\n<li><a href=\"https://github.com/dask/dask/issues/2225\" target=\"_blank\" title=\"https://github.com/dask/dask/issues/2225\">https://github.com/dask/dask/issues/2225</a></li>\n<li><a href=\"https://github.com/dask/dask/issues/3587\" target=\"_blank\" title=\"https://github.com/dask/dask/issues/3587\">https://github.com/dask/dask/issues/3587</a></li>\n</ol>",
        "id": 26319,
        "sender_full_name": "Deepak Cherian",
        "timestamp": 1614958962
    }
]