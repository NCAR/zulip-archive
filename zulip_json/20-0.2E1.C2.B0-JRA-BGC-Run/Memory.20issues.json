[
    {
        "content": "<p>I've run into my first set big issue with the high resolution run -- trying to use <code>shr_stream</code> to read the tracer restoring fields blows memory. I talked with <span class=\"user-mention\" data-user-id=\"31\">@Keith Lindsay</span> about it on Friday, and the best we can figure is that the share code reads the stream file on master task and then distributes it. From <code>cesm.log</code> in <code>/glade/scratch/mlevy/SMS_Ld1.TL319_t13.G1850ECOIAF_JRA_HR.cheyenne_intel.pop-highres_JRA_cice.019/run</code>:</p>\n<div class=\"codehilite\"><pre><span></span>828:MCT::m_AttrVect::init_: allocate() error, stat =41\n828:33C.MCT(MPEU)::die.: from MCT::m_AttrVect::init_()\n828:MPT ERROR: Rank 828(g:828) is aborting with error code 2.\n...\n828:MPT: #6  0x00000000010e6a2f in m_dropdead_mp_die__ ()\n828:MPT:     at /glade/work/mlevy/codes/CESM/cesm2_2_beta04+GECO_JRA_HR/cime/src/externals/mct/mpeu/m_dropdead.F90:87\n828:MPT: #7  0x00000000010e5bff in m_die_mp_die2__ ()\n828:MPT:     at /glade/work/mlevy/codes/CESM/cesm2_2_beta04+GECO_JRA_HR/cime/src/externals/mct/mpeu/m_die.F90:165\n828:MPT: #8  0x000000000106d57d in m_attrvect_mp_init__ ()\n828:MPT:     at /glade/work/mlevy/codes/CESM/cesm2_2_beta04+GECO_JRA_HR/cime/src/externals/mct/mct/m_AttrVect.F90:346\n828:MPT: #9  0x000000000106d1c0 in m_attrvect_mp_initv__ ()\n828:MPT:     at /glade/work/mlevy/codes/CESM/cesm2_2_beta04+GECO_JRA_HR/cime/src/externals/mct/mct/m_AttrVect.F90:434\n828:MPT: #10 0x000000000109b5d8 in m_generalgrid_mp_initgg__ ()\n828:MPT:     at /glade/work/mlevy/codes/CESM/cesm2_2_beta04+GECO_JRA_HR/cime/src/externals/mct/mct/m_GeneralGrid.F90:853\n828:MPT: #11 0x0000000000dfba30 in shr_dmodel_mod_mp_shr_dmodel_readgrid_ ()\n828:MPT:     at /glade/work/mlevy/codes/CESM/cesm2_2_beta04+GECO_JRA_HR/cime/src/share/streams/shr_dmodel_mod.F90:433\n828:MPT: #12 0x0000000000eae6d3 in shr_strdata_mod_mp_shr_strdata_init_streams_ ()\n828:MPT:     at /glade/work/mlevy/codes/CESM/cesm2_2_beta04+GECO_JRA_HR/cime/src/share/streams/shr_strdata_mod.F90:480\n828:MPT: #13 0x0000000000eaa309 in shr_strdata_mod_mp_shr_strdata_create_oldway_ ()\n828:MPT:     at /glade/work/mlevy/codes/CESM/cesm2_2_beta04+GECO_JRA_HR/cime/src/share/streams/shr_strdata_mod.F90:219\n828:MPT: #14 0x0000000000ac1582 in strdata_interface_mod_mp_pop_strdata_create_ ()\n828:MPT:     at /glade/scratch/mlevy/SMS_Ld1.TL319_t13.G1850ECOIAF_JRA_HR.cheyenne_intel.pop-highres_JRA_cice.019/bld/ocn/source/strdata_interface_mod.F90:184\n828:MPT: #15 0x000000000095a1a4 in ecosys_forcing_mod_mp_ecosys_forcing_set_interior_time_varying_forcing_data_ ()\n828:MPT:     at /glade/scratch/mlevy/SMS_Ld1.TL319_t13.G1850ECOIAF_JRA_HR.cheyenne_intel.pop-highres_JRA_cice.019/bld/ocn/source/ecosys_forcing_mod.F90:1576\n</pre></div>\n\n\n<p>There is an <code>allocate()</code> call in <a href=\"https://github.com/ESMCI/cime/blob/cime5.8.19/src/externals/mct/mct/m_AttrVect.F90#L345\" target=\"_blank\" title=\"https://github.com/ESMCI/cime/blob/cime5.8.19/src/externals/mct/mct/m_AttrVect.F90#L345\"><code>m_AttrVect.F90</code></a> that is failing, and additional tests is showing that <code>nRA = 7 n = 535680000</code> (so <code>n = 3600*2400*62</code>). Working under the assumption that \"just don't restore\" is not a good plan, I think there are three paths forward:</p>\n<ol>\n<li>See if there's a way to parallelize the read in <code>shr_stream</code></li>\n<li>See if the CMEPS (formerly NUOPC, formerly ESMF) cap is available, and, if so, if it parallelizes this read</li>\n<li>Update <code>ecosys_forcing_mod.F90</code> in POP to allow restoring to a constant value, and compute average value over the marginal seas in the file we are currently trying to restore to</li>\n</ol>",
        "id": 10782,
        "sender_full_name": "Michael Levy",
        "timestamp": 1591630755
    },
    {
        "content": "<p>I meant to add that <code>aV%rAttr</code> is ~28 GB in size, and <code>allocate() error, stat =41</code> indicates <a href=\"https://software.intel.com/content/www/us/en/develop/documentation/fortran-compiler-developer-guide-and-reference/top/compiler-reference/error-handling/handling-run-time-errors/list-of-run-time-error-messages.html\" target=\"_blank\" title=\"https://software.intel.com/content/www/us/en/develop/documentation/fortran-compiler-developer-guide-and-reference/top/compiler-reference/error-handling/handling-run-time-errors/list-of-run-time-error-messages.html\">\"[i]nsufficient virtual memory\"</a></p>",
        "id": 10783,
        "sender_full_name": "Michael Levy",
        "timestamp": 1591631126
    },
    {
        "content": "<p>Option 4. Don't apply the restoring. I think this is worth considering.</p>",
        "id": 10785,
        "sender_full_name": "Matt Long",
        "timestamp": 1591631702
    },
    {
        "content": "<p>I asked about this on the CIME slack board, and Jim said \"We are developing new esmf based data models with issues like this in mind.  Are you willing to try some bleeding edge code in your experiment?\" That won't be available in 2.2.0, so I think proceeding without restoring for now and then trying the new infrastructure seems like a good path forward.</p>",
        "id": 10794,
        "sender_full_name": "Michael Levy",
        "timestamp": 1591646568
    }
]