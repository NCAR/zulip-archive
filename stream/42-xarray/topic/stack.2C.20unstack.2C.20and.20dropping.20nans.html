<html>
<head><meta charset="utf-8"><title>stack, unstack, and dropping nans · xarray · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://127.0.0.1:4000/html/stream/42-xarray/index.html">xarray</a></h2>
<h3>Topic: <a href="http://127.0.0.1:4000/html/stream/42-xarray/topic/stack.2C.20unstack.2C.20and.20dropping.20nans.html">stack, unstack, and dropping nans</a></h3>

<hr>

<base href="https://zulip2.cloud.ucar.edu">

<head><link href="http://127.0.0.1:4000/style.css" rel="stylesheet"></head>

<a name="71582"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/42-xarray/topic/stack%2C%20unstack%2C%20and%20dropping%20nans/near/71582" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Michael Levy <a href="http://127.0.0.1:4000/html/stream/42-xarray/topic/stack.2C.20unstack.2C.20and.20dropping.20nans.html#71582">(Jan 11 2023 at 18:37)</a>:</h4>
<p>I've got a 2D array with some nans in it, and I want to pass it as an argument to a function that expects a 1D array without nans... so I stack my two dimensions, drop the nans, do the calculation, and then unstack the dimensions. But some of the 2D arrays have entire rows or columns of nans, and when I unstack those rows and columns are missing.</p>
<p>Here's a simple example to illustrate:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nparray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nparray</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nparray</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nparray</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nparray</span><span class="p">[</span><span class="mi">5</span><span class="p">,:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nparray</span> <span class="c1"># note that the first row, second-to-last row, and last column are entirely nans</span>
<span class="n">array</span><span class="p">([[</span><span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">],</span>
       <span class="p">[</span><span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">,</span> <span class="n">nan</span><span class="p">],</span>
       <span class="p">[</span><span class="n">nan</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">],</span>
       <span class="p">[</span><span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">,</span> <span class="n">nan</span><span class="p">]])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">nparray</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s1">'nlat'</span><span class="p">,</span> <span class="s1">'nlon'</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">'my_array'</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span><span class="p">[</span><span class="s1">'nlat'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span><span class="p">[</span><span class="s1">'nlon'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span> <span class="c1"># my original dataset has dimensions nlat=6, nlon=6</span>
<span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">&gt;</span>
<span class="n">Dimensions</span><span class="p">:</span>   <span class="p">(</span><span class="n">nlat</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="n">nlon</span><span class="p">:</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">Coordinates</span><span class="p">:</span>
  <span class="o">*</span> <span class="n">nlat</span>      <span class="p">(</span><span class="n">nlat</span><span class="p">)</span> <span class="n">int64</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span>
  <span class="o">*</span> <span class="n">nlon</span>      <span class="p">(</span><span class="n">nlon</span><span class="p">)</span> <span class="n">int64</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span>
<span class="n">Data</span> <span class="n">variables</span><span class="p">:</span>
    <span class="n">my_array</span>  <span class="p">(</span><span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">)</span> <span class="n">float64</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="n">nan</span> <span class="o">...</span> <span class="mf">4.0</span> <span class="mf">4.0</span> <span class="mf">4.0</span> <span class="mf">4.0</span> <span class="n">nan</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="p">[</span><span class="s1">'nlat'</span><span class="p">,</span> <span class="s1">'nlon'</span><span class="p">])</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">'my_array'</span><span class="p">]),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span> <span class="c1"># after the stack, drop, unstack sequence my dataset has dimensions nlat=4, nlon=5</span>
<span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">&gt;</span>
<span class="n">Dimensions</span><span class="p">:</span>   <span class="p">(</span><span class="n">nlat</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="n">nlon</span><span class="p">:</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">Coordinates</span><span class="p">:</span>
  <span class="o">*</span> <span class="n">nlat</span>      <span class="p">(</span><span class="n">nlat</span><span class="p">)</span> <span class="n">int64</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">5</span>
  <span class="o">*</span> <span class="n">nlon</span>      <span class="p">(</span><span class="n">nlon</span><span class="p">)</span> <span class="n">int64</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span>
<span class="n">Data</span> <span class="n">variables</span><span class="p">:</span>
    <span class="n">my_array</span>  <span class="p">(</span><span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span><span class="p">)</span> <span class="n">float64</span> <span class="mf">1.0</span> <span class="mf">1.0</span> <span class="mf">1.0</span> <span class="n">nan</span> <span class="n">nan</span> <span class="o">...</span> <span class="mf">4.0</span> <span class="mf">4.0</span> <span class="mf">4.0</span> <span class="mf">4.0</span> <span class="mf">4.0</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ds</span><span class="p">[</span><span class="s1">'my_array'</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="c1"># looking at the underlying data, the rows and column that were all nan are now missing</span>
<span class="n">array</span><span class="p">([[</span> <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">],</span>
       <span class="p">[</span><span class="n">nan</span><span class="p">,</span> <span class="n">nan</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">],</span>
       <span class="p">[</span><span class="n">nan</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">,</span>  <span class="mf">8.</span><span class="p">,</span> <span class="n">nan</span><span class="p">],</span>
       <span class="p">[</span> <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">]])</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div>
<p>Notice that the <code>nlat</code> coordinate no longer has a 0 or 4 value, and <code>nlon</code> is missing 7 so what started out as a 6x6 matrix is now 4x5. In practice, I'm doing this stacking / unstacking inside a call to <code>xr.map_blocks()</code>; in the example above, if the template is expecting each chunk to return a 6x6 portion of the bigger matrix then <code>map_blocks()</code> would throw an exception from the chunks that have lost some <code>nan</code>s.</p>
<p>If I save the original <code>nlat</code> and <code>nlon</code> coordinates, is there a way to <code>unstack()</code> into a dataset with the original dimensions?</p>



<hr><p>Last updated: Dec 17 2024 at 18:57 UTC</p>
</html>