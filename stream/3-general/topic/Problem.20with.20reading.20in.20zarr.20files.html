<html>
<head><meta charset="utf-8"><title>Problem with reading in zarr files · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="http://127.0.0.1:4000/html/stream/3-general/index.html">general</a></h2>
<h3>Topic: <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html">Problem with reading in zarr files</a></h3>

<hr>

<base href="https://zulip2.cloud.ucar.edu">

<head><link href="http://127.0.0.1:4000/style.css" rel="stylesheet"></head>

<a name="34526"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34526" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Judith Berner <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34526">(Jun 15 2021 at 21:18)</a>:</h4>
<p>I am running  a script that worked recently. Now I get an error when reading in zarr files (netcdf  ok). Is that realted to the recent issues or is there a fix. Unfortunately, I don't  understand the error message.</p>



<a name="34527"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34527" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Grover <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34527">(Jun 15 2021 at 21:18)</a>:</h4>
<p>What error are you getting?</p>



<a name="34528"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34528" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Judith Berner <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34528">(Jun 15 2021 at 21:19)</a>:</h4>
<p><a href="/user_uploads/2/6/HJgwP2wAwxOamx9jv-MebdoD/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/6/HJgwP2wAwxOamx9jv-MebdoD/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/2/6/HJgwP2wAwxOamx9jv-MebdoD/pasted_image.png"></a></div>



<a name="34529"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34529" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Judith Berner <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34529">(Jun 15 2021 at 21:19)</a>:</h4>
<p><a href="/user_uploads/2/f2/QkFEi2SQVkvqBzuqUdHiJEG4/pasted_image.png" target="_blank" title="pasted_image.png">pasted image</a></p>
<div class="message_inline_image"><a href="/user_uploads/2/f2/QkFEi2SQVkvqBzuqUdHiJEG4/pasted_image.png" target="_blank" title="pasted image"><img src="/user_uploads/2/f2/QkFEi2SQVkvqBzuqUdHiJEG4/pasted_image.png"></a></div>



<a name="34530"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34530" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Judith Berner <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34530">(Jun 15 2021 at 21:20)</a>:</h4>
<blockquote>
<p>What error are you getting?</p>
</blockquote>
<p>There must be a better way sharing code than pasting screenshots...</p>



<a name="34531"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34531" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Grover <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34531">(Jun 15 2021 at 21:23)</a>:</h4>
<p>Looks like that Zarr file you are trying to read in might be missing its consolidated metadata... any thoughts <span class="user-mention" data-user-id="13">@Anderson Banihirwe</span> ? <a href="https://stackoverflow.com/questions/66144743/getting-keyerror-zmetadata-when-opening-remote-zarr-store" target="_blank" title="https://stackoverflow.com/questions/66144743/getting-keyerror-zmetadata-when-opening-remote-zarr-store">https://stackoverflow.com/questions/66144743/getting-keyerror-zmetadata-when-opening-remote-zarr-store</a></p>



<a name="34532"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34532" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Judith Berner <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34532">(Jun 15 2021 at 21:31)</a>:</h4>
<blockquote>
<p>Looks like that Zarr file you are trying to read in might be missing its consolidated metadata... any thoughts <span class="user-mention silent" data-user-id="13">Anderson Banihirwe</span> ? <a href="https://stackoverflow.com/questions/66144743/getting-keyerror-zmetadata-when-opening-remote-zarr-store" target="_blank" title="https://stackoverflow.com/questions/66144743/getting-keyerror-zmetadata-when-opening-remote-zarr-store">https://stackoverflow.com/questions/66144743/getting-keyerror-zmetadata-when-opening-remote-zarr-store</a></p>
</blockquote>
<p>I tried a number of different zarr files, restarted kernel etc. must be something more fundamental.</p>



<a name="34533"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34533" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Max Grover <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34533">(Jun 15 2021 at 21:32)</a>:</h4>
<p>Can you share a path to one of the zarr files?</p>



<a name="34534"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34534" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Judith Berner <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34534">(Jun 15 2021 at 21:35)</a>:</h4>
<blockquote>
<p>Can you share a path to one of the zarr files?</p>
</blockquote>
<p>#hinda2 = xr.open_zarr("/glade/campaign/cesm/development/cross-wg/S2S/jaye/CESM2.S2S.tas_2m.anoms.zarr/"glade/campaign/cesm/development/cross-wg/S2S/jaye<br>
#hinda1 = xr.open_zarr("/glade/campaign/cesm/development/cross-wg/S2S/jaye/CESM1.S2S.tas_2m.anoms.zarr/", consolidated=True)<br>
#hindaw = xr.open_zarr("/glade/campaign/cesm/development/cross-wg/S2S/jaye/WACCM.S2S.tas_2m.anoms.zarr/", consolidated=True)</p>



<a name="34539"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34539" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deepak Cherian <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34539">(Jun 15 2021 at 22:04)</a>:</h4>
<p>Does <code>consolidated=False</code> help?</p>



<a name="34541"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34541" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anderson Banihirwe <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34541">(Jun 15 2021 at 22:26)</a>:</h4>
<p><span class="user-mention" data-user-id="48">@Judith Berner</span>, Deepak's suggestion should address your issue: </p>
<div class="codehilite"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="s2">&quot;/glade/campaign/cesm/development/cross-wg/S2S/jaye/WACCM.S2S.tas_2m.anoms.zarr/&quot;</span>
   <span class="o">...</span><span class="p">:</span> <span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
<span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">&gt;</span>
<span class="n">Dimensions</span><span class="p">:</span>    <span class="p">(</span><span class="n">init</span><span class="p">:</span> <span class="mi">655</span><span class="p">,</span> <span class="n">lat</span><span class="p">:</span> <span class="mi">181</span><span class="p">,</span> <span class="n">lead</span><span class="p">:</span> <span class="mi">46</span><span class="p">,</span> <span class="n">lon</span><span class="p">:</span> <span class="mi">360</span><span class="p">,</span> <span class="n">member</span><span class="p">:</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">Coordinates</span><span class="p">:</span>
    <span class="n">dayofyear</span>  <span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="n">int64</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">&lt;</span><span class="n">chunksize</span><span class="o">=</span><span class="p">(</span><span class="mi">211</span><span class="p">,),</span> <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">&gt;</span>
  <span class="o">*</span> <span class="n">init</span>       <span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="nb">object</span> <span class="mi">1999</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">04</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span> <span class="o">...</span> <span class="mi">2020</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">26</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span>
  <span class="o">*</span> <span class="n">lat</span>        <span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="n">float32</span> <span class="o">-</span><span class="mf">90.0</span> <span class="o">-</span><span class="mf">89.0</span> <span class="o">-</span><span class="mf">88.0</span> <span class="o">-</span><span class="mf">87.0</span> <span class="o">...</span> <span class="mf">87.0</span> <span class="mf">88.0</span> <span class="mf">89.0</span> <span class="mf">90.0</span>
  <span class="o">*</span> <span class="n">lead</span>       <span class="p">(</span><span class="n">lead</span><span class="p">)</span> <span class="n">int64</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="o">...</span> <span class="mi">37</span> <span class="mi">38</span> <span class="mi">39</span> <span class="mi">40</span> <span class="mi">41</span> <span class="mi">42</span> <span class="mi">43</span> <span class="mi">44</span> <span class="mi">45</span>
  <span class="o">*</span> <span class="n">lon</span>        <span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="n">float32</span> <span class="mf">0.0</span> <span class="mf">1.0</span> <span class="mf">2.0</span> <span class="mf">3.0</span> <span class="mf">4.0</span> <span class="o">...</span> <span class="mf">356.0</span> <span class="mf">357.0</span> <span class="mf">358.0</span> <span class="mf">359.0</span>
  <span class="o">*</span> <span class="n">member</span>     <span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="n">int64</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span>
<span class="n">Data</span> <span class="n">variables</span><span class="p">:</span>
    <span class="n">TAS</span>        <span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">lead</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="n">float32</span> <span class="n">dask</span><span class="o">.</span><span class="n">array</span><span class="o">&lt;</span><span class="n">chunksize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">655</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span> <span class="n">meta</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">&gt;</span>
</pre></div>



<a name="34542"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34542" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deepak Cherian <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34542">(Jun 15 2021 at 22:27)</a>:</h4>
<p>we should open an issue about raising a more useful error message, possibly in zarr. WDYT Anderson</p>



<a name="34548"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34548" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anderson Banihirwe <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34548">(Jun 15 2021 at 22:36)</a>:</h4>
<p>@Judith Berner, if you want to use the <code>consolidated=True</code> option in the future, ensure <code>consolidated</code> is set to True when saving the data: <code>ds.to_zarr(...., consolidated=True)</code></p>
<blockquote>
<p>we should open an issue about raising a more useful error message, possibly in zarr. WDYT Anderson</p>
</blockquote>
<p>Considering how common this error/issue is,It's  reasonable for xarray to be less strict here:</p>
<div class="codehilite"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="o">....</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
   <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Raise an exception if still unable to read the zarr store</span>
</pre></div>


<p>xarray already does something along these lines when decoding calendars using <code>cftime</code> and <code>pandas</code> in <code>xr.open_dataset(...., use_cftime=None)</code></p>



<a name="34549"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34549" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anderson Banihirwe <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34549">(Jun 15 2021 at 22:37)</a>:</h4>
<p><span class="user-mention" data-user-id="25">@Deepak Cherian</span>, it turns out that Stephan already has a proposal for this: <a href="https://github.com/pydata/xarray/issues/5251" target="_blank" title="https://github.com/pydata/xarray/issues/5251">https://github.com/pydata/xarray/issues/5251</a> <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="34552"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34552" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deepak Cherian <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34552">(Jun 15 2021 at 22:38)</a>:</h4>
<p>and a PR! but I meant raising a nicer error message from zarr, saying that "consolidated metadata do not exist. Please pass consolidated=False".</p>



<a name="34559"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34559" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anderson Banihirwe <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34559">(Jun 15 2021 at 22:43)</a>:</h4>
<blockquote>
<p>and a PR! but I meant raising a nicer error message from zarr, saying that "consolidated metadata do not exist. Please pass consolidated=False".</p>
</blockquote>
<p>Oooh I see... That would be nice.. I will open an issue upstream</p>



<a name="34570"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/3-general/topic/Problem%20with%20reading%20in%20zarr%20files/near/34570" class="zl"><img src="http://127.0.0.1:4000/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Judith Berner <a href="http://127.0.0.1:4000/html/stream/3-general/topic/Problem.20with.20reading.20in.20zarr.20files.html#34570">(Jun 16 2021 at 00:27)</a>:</h4>
<p><span class="user-mention" data-user-id="127">@Abby Jaye</span></p>



<hr><p>Last updated: Dec 17 2024 at 18:57 UTC</p>
</html>