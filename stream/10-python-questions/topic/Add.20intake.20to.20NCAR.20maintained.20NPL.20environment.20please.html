<html>
<head><meta charset="utf-8"><title>Add intake to NCAR maintained NPL environment please · python-questions · Zulip Chat Archive</title></head>
<h2>Stream: <a href="../../..//stream/10-python-questions/index.html">python-questions</a></h2>
<h3>Topic: <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html">Add intake to NCAR maintained NPL environment please</a></h3>

<hr>


<head><link href="../../../style.css" rel="stylesheet"></head>

<a name="83282"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83282" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83282">(Jun 21 2023 at 23:11)</a>:</h4>
<p>Hi all, I am not sure who to contact about this, but could we please add <code>intake</code> to the maintained NPL environment(s)? It seems a fairly standard package if you are dealing with CESM output.</p>



<a name="83304"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83304" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Katie Dagon <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83304">(Jun 22 2023 at 16:17)</a>:</h4>
<p>Great idea <span class="user-mention" data-user-id="27">@Anna-Lena Deppenmeier</span> ! There is some information <a href="https://arc.ucar.edu/knowledge_base/83853599">here</a> on the NPL update schedule, and I'm thinking that submitting a <a href="https://ithelp.ucar.edu/plugins/servlet/desk/site/rc">research computing help ticket</a> is probably the best way to get <code>intake</code> on their radar and into the next released version.</p>



<a name="83306"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83306" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83306">(Jun 22 2023 at 16:28)</a>:</h4>
<p>Thanks for the pointers <span class="user-mention" data-user-id="47">@Katie Dagon</span>, I'll go ahead and submit a ticket!</p>



<a name="83352"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83352" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deepak Cherian <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83352">(Jun 22 2023 at 18:54)</a>:</h4>
<p>Just checked with Ben Kirk, and the tickets (<a href="http://help.ucar.edu">help.ucar.edu</a>) are the best way of new packages at the moment</p>



<a name="83388"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83388" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83388">(Jun 22 2023 at 20:07)</a>:</h4>
<p>We are adding <code>intake</code> and <code>intake-esm</code> to NPL, but the best way for now is creating a new ticket with RC and pursue that. I created a ticket on this today morning. </p>
<p>In future we are going to update this to a Github repository, so new requests can come through the Github issues. (But not implemented now).</p>



<a name="83389"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83389" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deepak Cherian <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83389">(Jun 22 2023 at 20:11)</a>:</h4>
<blockquote>
<p>In future we are going to update this to a Github repository, so new requests can come through the Github issues.</p>
</blockquote>
<p>That would be perfect!</p>



<a name="83408"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83408" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83408">(Jun 22 2023 at 21:27)</a>:</h4>
<p>We have added <code>intake</code>, <code>intake-esm</code>, <code>intake-xarray</code>, and <code>flox</code> to the base environment. <span class="user-mention" data-user-id="27">@Anna-Lena Deppenmeier</span> and <span class="user-mention" data-user-id="25">@Deepak Cherian</span></p>



<a name="83409"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83409" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Deepak Cherian <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83409">(Jun 22 2023 at 21:28)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="71">@Negin Sobhani</span> !</p>



<a name="83411"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83411" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83411">(Jun 22 2023 at 21:46)</a>:</h4>
<p>That's fantastic, thanks <span class="user-mention" data-user-id="71">@Negin Sobhani</span> !!</p>



<a name="83621"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83621" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83621">(Jun 23 2023 at 18:37)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="71">@Negin Sobhani</span>  I can open a new ticket but wanted to make mention of this here -- <code>intake</code> is hanging , i.e. not working with the NPL environment right now. I tested with <span class="user-mention" data-user-id="28">@Kristen Krumhardt</span>  and for her it's the same, the NPL environment doesn't work but her own environment is able to process the cells fairly quickly.  I can point you to the yml she installed from (and I am trying to install from right now) if it's of any use.</p>



<a name="83924"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83924" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83924">(Jun 26 2023 at 20:12)</a>:</h4>
<p>Hello <span class="user-mention" data-user-id="27">@Anna-Lena Deppenmeier</span> ,  Thanks for raising this issue. I have just tested the <code>npl-2023a</code> (which is the latest NPL flavor) and it seems like that the <code>intake</code> package works. Can you please let me know which environment you use for this? </p>
<div class="codehilite"><pre><span></span><code>import intake
catalog_url = &#39;https://ncar-cesm-lens.s3-us-west-2.amazonaws.com/catalogs/aws-cesm1-le.json&#39;
col = intake.open_esm_datastore(catalog_url)
col
</code></pre></div>



<a name="83925"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83925" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83925">(Jun 26 2023 at 20:15)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="71">@Negin Sobhani</span> , this also works for me, the line that is hanging is this after having created a catalogue: </p>
<div class="codehilite"><pre><span></span><code>%%time
catalog = intake.open_esm_datastore(
    &#39;/glade/collections/cmip/catalog/intake-esm-datastore/catalogs/glade-cesm2-le.json&#39;)
catalog.df.experiment.unique()
</code></pre></div>
<p>works, </p>
<div class="codehilite"><pre><span></span><code>%%time
var = [&#39;TEMP&#39;,&#39;SALT&#39;]
# get the historical
subset_hist = catalog.search(component=&#39;ocn&#39;,
                        variable=var,
                        experiment=&#39;historical&#39;,
                        forcing_variant=&#39;cmip6&#39;)
</code></pre></div>
<p>works, but </p>
<div class="codehilite"><pre><span></span><code>%%time
with dask.config.set(**{&#39;array.slicing.split_large_chunks&#39;: True}):
    dsets = subset_hist.to_dataset_dict(preprocess=preprocess)
</code></pre></div>
<p>hangs. it seems to actually open the data, i can see dask processes moving, but it never completes the cell. note that I tried with different definitions for preprocessing and it didn't work for either, but the same command runs fine in my personal environment.<br>
Thanks for looking into it!</p>



<a name="83926"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83926" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83926">(Jun 26 2023 at 20:21)</a>:</h4>
<p><span class="user-mention" data-user-id="27">@Anna-Lena Deppenmeier</span> This looks like an issue with Dask rather than intake. But please let me take a closer look at this.</p>



<a name="83927"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83927" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83927">(Jun 26 2023 at 20:22)</a>:</h4>
<p>Oh yeah that makes sense! There have been other issues with dask too, it would be great to get to the bottom of this. Thanks!</p>



<a name="83985"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83985" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83985">(Jun 26 2023 at 22:10)</a>:</h4>
<p>Hello <span class="user-mention" data-user-id="27">@Anna-Lena Deppenmeier</span> , Interestingly when I explore other catalogs this environment works without any issues with Dask. But with this catalog, I am experiencing an issue similar to what you reports and Dask workers are stay idle. </p>
<p>Here is an example that works fine with npl-2023a +dask : </p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">import</span> <span class="nn">intake</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">from</span> <span class="nn">dask_jobqueue</span> <span class="kn">import</span> <span class="n">PBSCluster</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>

<span class="c1"># Create a PBS cluster object</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">PBSCluster</span><span class="p">(</span>
    <span class="n">job_name</span> <span class="o">=</span> <span class="s1">'dask-wk23-hpc'</span><span class="p">,</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">memory</span> <span class="o">=</span> <span class="s1">'4GiB'</span><span class="p">,</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">local_directory</span> <span class="o">=</span> <span class="s1">'/local_scratch/pbs.$PBS_JOBID/dask/spill'</span><span class="p">,</span>
    <span class="n">resource_spec</span> <span class="o">=</span> <span class="s1">'select=1:ncpus=1:mem=4GB'</span><span class="p">,</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="s1">'casper'</span><span class="p">,</span>
    <span class="n">walltime</span> <span class="o">=</span> <span class="s1">'30:00'</span><span class="p">,</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="s1">'ib0'</span>
<span class="p">)</span>


<span class="n">catalog_url</span> <span class="o">=</span> <span class="s1">'https://ncar-cesm-lens.s3-us-west-2.amazonaws.com/catalogs/aws-cesm1-le.json'</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_esm_datastore</span><span class="p">(</span><span class="n">catalog_url</span><span class="p">)</span>
<span class="n">col</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
<span class="n">client</span>

<span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">client</span><span class="o">.</span><span class="n">wait_for_workers</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="n">col_subset</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="p">[</span><span class="s2">"daily"</span><span class="p">,</span> <span class="s2">"monthly"</span><span class="p">],</span> <span class="n">component</span><span class="o">=</span><span class="s2">"atm"</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s2">"TREFHT"</span><span class="p">,</span>
                        <span class="n">experiment</span><span class="o">=</span><span class="p">[</span><span class="s2">"20C"</span><span class="p">,</span> <span class="s2">"RCP85"</span><span class="p">,</span> <span class="s2">"HIST"</span><span class="p">])</span>

<span class="n">col_subset</span>

<span class="n">dsets</span> <span class="o">=</span> <span class="n">col_subset</span><span class="o">.</span><span class="n">to_dataset_dict</span><span class="p">()</span>
<span class="n">dsets</span>
</code></pre></div>
<p>So I think the problem is either with the catalog or some other packages missing that is required for transforming the data. Can you please confirm that the catalog works with another environment? I am still looking at this to find out what is causing this issue.</p>



<a name="83988"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83988" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83988">(Jun 26 2023 at 22:34)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="71">@Negin Sobhani</span> , yes this catalogue works with other environments. I could point you to an example environment file that I know it works with if that's helpful?</p>



<a name="83991"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83991" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83991">(Jun 27 2023 at 00:17)</a>:</h4>
<p>Yes , <span class="user-mention" data-user-id="27">@Anna-Lena Deppenmeier</span> , Can you please point me to the exact code and environment where this works?</p>



<a name="83992"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83992" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83992">(Jun 27 2023 at 00:25)</a>:</h4>
<p>When I try reading in a subset of data it worked without any issue with two workers in <code>npl-2023a</code>.<br>
 Please feel free to try it: </p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">catalog_url</span> <span class="o">=</span> <span class="s1">'/glade/collections/cmip/catalog/intake-esm-datastore/catalogs/glade-cesm2-le.json'</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_esm_datastore</span><span class="p">(</span><span class="n">catalog_url</span><span class="p">)</span>
<span class="n">col</span>

<span class="c1"># get the historical</span>
<span class="n">col_subset</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s2">"ocn"</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s2">"TEMP"</span><span class="p">,</span>
                        <span class="n">experiment</span><span class="o">=</span><span class="s2">"historical"</span><span class="p">,</span> <span class="n">forcing_variant</span><span class="o">=</span><span class="s1">'cmip6'</span><span class="p">,</span><span class="n">member_id</span><span class="o">=</span><span class="s1">'r1i1001p1f1'</span><span class="p">)</span>

<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s1">'array.slicing.split_large_chunks'</span><span class="p">:</span> <span class="kc">True</span><span class="p">}):</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">col_subset</span><span class="o">.</span><span class="n">to_dataset_dict</span><span class="p">()</span>
</code></pre></div>



<a name="83996"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83996" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83996">(Jun 27 2023 at 15:00)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="71">@Negin Sobhani</span> , can you do the same for two variables?  I don't know the syntax in the block of code above to modify it to two variables, will it be <code>variable=['TEMP', 'SALT']</code>? Also do you think it works better with less workers (you mention two)? I will need more than two workers to eventually do anything with the dataset, but I guess I could load it with 2 and then <code>cluster.scale(12)</code>?</p>



<a name="83997"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/83997" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#83997">(Jun 27 2023 at 15:03)</a>:</h4>
<p>also do you still need the environment since it's working for you now?</p>



<a name="84431"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/84431" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#84431">(Jun 28 2023 at 20:26)</a>:</h4>
<p><span class="user-mention" data-user-id="27">@Anna-Lena Deppenmeier</span> , if you use the list (i.e. ['TEMP','SALT'] ) instead of 'TEMP' this should work too.<br>
 I have tested the following (adding SALT) and it worked fine. I am using 8 dask workers and overall I usually set the number of dask workers based on the memory/CPU needs of a notebook. </p>
<p>Here is my code: </p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">catalog_url</span> <span class="o">=</span> <span class="s1">'/glade/collections/cmip/catalog/intake-esm-datastore/catalogs/glade-cesm2-le.json'</span>
<span class="n">col</span> <span class="o">=</span> <span class="n">intake</span><span class="o">.</span><span class="n">open_esm_datastore</span><span class="p">(</span><span class="n">catalog_url</span><span class="p">)</span>
<span class="c1"># get the historical</span>
<span class="n">col_subset</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s2">"ocn"</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="p">[</span><span class="s1">'TEMP'</span><span class="p">,</span><span class="s1">'SALT'</span><span class="p">],</span>
                        <span class="n">experiment</span><span class="o">=</span><span class="s2">"historical"</span><span class="p">,</span> <span class="n">forcing_variant</span><span class="o">=</span><span class="s1">'cmip6'</span><span class="p">,</span><span class="n">member_id</span><span class="o">=</span><span class="s1">'r1i1001p1f1'</span><span class="p">)</span>
<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s1">'array.slicing.split_large_chunks'</span><span class="p">:</span> <span class="kc">True</span><span class="p">}):</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">col_subset</span><span class="o">.</span><span class="n">to_dataset_dict</span><span class="p">()</span>
</code></pre></div>
<p>Please note that I am still reading in a subset (2%) of the data ( see the <code>member_id</code>argument) and it takes a few minutes to complete. <br>
I am wondering if you can point me to the environment that you used that read in the data quickly. <br>
Thanks!<br>
Negin</p>



<a name="84436"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/84436" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#84436">(Jun 28 2023 at 20:41)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="71">@Negin Sobhani</span> ! The environment file is here: <code>/glade/u/home/deppenme/analysis6_versions.yml</code></p>



<a name="84543"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/84543" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#84543">(Jun 29 2023 at 19:16)</a>:</h4>
<p>Hello <span class="user-mention" data-user-id="27">@Anna-Lena Deppenmeier</span> , Thanks for sending the environment.<br>
I did several different test with this catalogue and it seems like althought the Dask workers are not hung, they are extremely slow. I cannot see high CPU or mem usage on any workers. But for example reading in half of your data took ~32 minutes on 60+ workers. </p>
<p>Can you please confirm that how much memory do you typically request for the main server you start up (if it's a login server, you'd get 4 GB)? Although I don't think this is causing the issue for you. As I have already tested with higher memory and did not see any improvement. </p>
<p>I am currently testing your environment to see if I can reproduce your result in loading the dataset quickly as you mentioned earlier. If that is not the case, we can rule out that the source of this issue is the <code>npl</code> environment and look at diagnosing this.</p>



<a name="84544"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/84544" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#84544">(Jun 29 2023 at 19:18)</a>:</h4>
<p>Hi Negin, I request a large amount of memory when I log in, something between 40 and 100GB and I log in via jupyterhub on the acasper PBS system rather than the login node</p>



<a name="84545"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/84545" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#84545">(Jun 29 2023 at 19:20)</a>:</h4>
<p>Good to know. Thanks for confirming that. As we suspect this issue is probably different from what <span class="user-mention" data-user-id="199">@Holly Olivarez</span> is experiencing.</p>



<a name="84546"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/84546" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anna-Lena Deppenmeier <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#84546">(Jun 29 2023 at 19:20)</a>:</h4>
<p>ok</p>



<a name="84548"></a>
<h4><a href="https://zulip2.cloud.ucar.edu#narrow/stream/10-python-questions/topic/Add%20intake%20to%20NCAR%20maintained%20NPL%20environment%20please/near/84548" class="zl"><img src="../../../assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Negin Sobhani <a href="../../..//stream/10-python-questions/topic/Add.20intake.20to.20NCAR.20maintained.20NPL.20environment.20please.html#84548">(Jun 29 2023 at 19:33)</a>:</h4>
<p>I can confirm that your environment is loading half dataset on the same number of workers in 8 seconds! </p>
<p>The issue might be due to some incompatibility between <code>intake</code> and <code>dask</code> versions. For reference, I am putting the versions of both environments here:</p>
<p>npl-2023a:</p>
<div class="codehilite"><pre><span></span><code>dask                      2022.10.0
intake                    0.7.0
intake-esm                2023.6.14
xarray                    2023.1.0
</code></pre></div>
<p>analysis6: </p>
<div class="codehilite"><pre><span></span><code>dask                      2021.11.2
intake                    0.6.7
intake-esm                2021.8.17
xarray                    0.20.2
</code></pre></div>



<hr><p>Last updated: May 16 2025 at 17:14 UTC</p>
</html>